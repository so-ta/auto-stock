# フェーズ分割計画書

> **Version**: 1.0.0
> **作成日**: 2026-01-28
> **参照仕様**: /Users/souta/Project/stock/要求.md

## 概要

本ドキュメントは「自動検証＆動的アロケーション」システムの実装フェーズを定義する。
全6フェーズで構成され、各フェーズは明確な依存関係を持つ。

```
Phase 1 ──→ Phase 2 ──→ Phase 3 ──→ Phase 4 ──→ Phase 5
    │                        │                        │
    └────────────────────────┴────────────────────────┘
                              ↓
                          Phase 6
```

---

## Phase 1: 基盤構築（データ取得・品質チェック）

### 目的

信頼性の高いデータパイプラインを構築し、下流の検証・配分処理が
正確なデータに基づいて動作することを保証する。

### 成果物

| 成果物 | 説明 |
|--------|------|
| `data_fetcher` | OHLCV データ取得モジュール |
| `quality_checker` | データ品質検査モジュール |
| `calendar_manager` | タイムゾーン・取引カレンダー管理 |
| `cost_model` | 手数料・スリッページモデル |

### 依存関係

- なし（最初のフェーズ）

### 技術的ポイント

1. **データ品質チェック項目**（§3より）
   - 欠損率（バー欠落）・連続欠損
   - 異常値（前バー比の極端な変化、出来高ゼロ等）
   - 重複バー
   - 時系列の単調増加（未来データ混入の疑い）

2. **品質NG時の処理**
   - 当該Assetは当日評価対象から除外
   - 除外理由をログに記録

3. **コストモデル**
   - `fee_bps`: 取引手数料（例: 2.0bps）
   - `slippage_bps`: スリッページ（例: 5.0bps）

### 参照仕様セクション

- §3 入力データ要件

---

## Phase 2: Signal/Strategy層

### 目的

個別指標・アノマリー・ルールを統一インターフェースで定義し、
戦略のカタログ化と動的組み込みを可能にする。

### 成果物

| 成果物 | 説明 |
|--------|------|
| `signal_base` | Signal抽象クラス・インターフェース |
| `strategy_base` | Strategy抽象クラス |
| `signal_catalog` | 実装済みSignal群（BB、モメンタム等） |
| `normalizer` | 出力正規化ユーティリティ |

### 依存関係

- **Phase 1**: データ取得モジュールが必要

### 技術的ポイント

1. **Signal設計原則**（§4より）
   - 純関数設計: 入力（過去データ）→ 出力（ポジション提案/スコア）
   - 出力正規化: **[-1, +1]**（ショート〜ロング）
   - 例: BB逆張りは逸脱量をtanhで圧縮

2. **パラメータ管理**
   - 「探索対象」と「固定」を明確に分離
   - 探索範囲は事前固定

3. **候補Signal例**
   - ボリンジャーバンド（逆張り/順張り）
   - モメンタム（n日リターン）
   - リバーサル（短期逆張り）
   - ブレイクアウト（高値更新/レンジ）
   - 出来高アノマリー
   - 季節性（曜日・月初月末）※過学習注意

### 参照仕様セクション

- §4 シグナル/戦略カタログの扱い

---

## Phase 3: 検証基盤（ウォークフォワード・評価指標）

### 目的

過学習・データリークを防止した堅牢な検証フレームワークを構築し、
Strategy×Assetの性能を定量的に評価する。

### 成果物

| 成果物 | 説明 |
|--------|------|
| `walk_forward_validator` | ウォークフォワード検証エンジン |
| `time_series_cv` | 時系列交差検証モジュール |
| `metrics_calculator` | 評価指標計算モジュール |
| `gate_checker` | ハードゲート判定モジュール |

### 依存関係

- **Phase 1**: データ取得・品質チェック
- **Phase 2**: Signal/Strategy定義

### 技術的ポイント

1. **ウォークフォワード検証**（§5より）
   - train/test期間を時間方向に分離
   - 例: train 2年 → test 1ヶ月、毎月更新
   - ランダムシャッフル禁止

2. **評価指標**（§6より）
   - 期待値（平均リターン、コスト控除後）
   - ボラティリティ
   - シャープ/ソルティノ（年率化ルール明示）
   - 最大ドローダウン（MDD）
   - テールリスク（5% VaR/ES）
   - 回転率（turnover）
   - トレード数/有効サンプル数

3. **ハードゲート（棄却ルール）**
   - `min_trades`: test期間のトレード数 < 閾値
   - `max_mdd`: MDD > 閾値
   - `min_ev`: コスト控除後の期待値 <= 0
   - 安定性: 過去N期のうちK期で期待値マイナス

### 参照仕様セクション

- §5 検証方式
- §6 評価指標

---

## Phase 4: Meta層（戦略アンサンブル）

### 目的

個別Strategyの選別と重み付けを行い、
「直近で偶然勝っただけ」を避けつつ環境変化に追随する
ロバストなアンサンブルを実現する。

### 成果物

| 成果物 | 説明 |
|--------|------|
| `strategy_scorer` | スコアリングモジュール |
| `strategy_weighter` | 戦略重み計算（softmax + 制約） |
| `entropy_controller` | 多様性維持（エントロピー下限） |
| `meta_optimizer` | Meta層最適化エンジン |

### 依存関係

- **Phase 3**: 評価指標が必要

### 技術的ポイント

1. **スコアリング**（§7.2より）
   ```
   score = Sharpe_adj - penalty
   penalty = λ1 * turnover + λ2 * MDD + λ3 * instability
   ```
   - 係数λは固定値として管理

2. **戦略重み計算**（§7.3より）
   - ゲートで不合格を除外
   - 残りを `w_s ∝ exp(β * score_s)` で重み付け
   - 上限制約: `w_s <= w_strategy_max`
   - 低スコアは0にクリップ（スパース化）

3. **過剰適応対策**（§7.4より）
   - βは固定 or 上限付き
   - エントロピー下限で多様性維持
   - 「勝ち始めた戦略への全乗り」を防止

### 参照仕様セクション

- §7 Strategyの採用と重み

---

## Phase 5: Asset配分層（HRP/リスクパリティ）

### 目的

全Assetの最終エクスポージャ（重み）を決定し、
期待リターンとリスクのバランスを最適化する。

### 成果物

| 成果物 | 説明 |
|--------|------|
| `hrp_allocator` | 階層リスクパリティ実装 |
| `risk_parity_allocator` | リスクパリティ実装 |
| `covariance_estimator` | 共分散推定（Ledoit-Wolf等） |
| `constraint_handler` | 制約処理（総和、上限、変更量） |
| `smoother` | 重みスムージングモジュール |

### 依存関係

- **Phase 4**: 戦略重みとアンサンブル後の期待リターン推定

### 技術的ポイント

1. **推奨アルゴリズム**（§8.3より）
   - **HRP（階層リスクパリティ）**: 推定誤差に強く、多アセットで堅い
   - **リスクパリティ（RP）**: シンプルで安定
   - Markowitz使用時は強い正則化必須

2. **制約**（§8.4より）
   - 総和: `Σ_a w_a = 1`
   - 上限: `w_a <= w_asset_max`
   - 下限: `w_a >= 0`（ロングオンリー）
   - 変更量: `|w_a(t) - w_a(t-1)| <= delta_max`
   - 相関集中の抑制（同クラスタ合計上限）

3. **スムージング**（§8.6より）
   - `w_final = α * w_new + (1-α) * w_prev`
   - または週次リバランス

4. **品質NG時の扱い**（§8.5より）
   - `w_a = 0` または前日維持
   - ルール固定、理由をログ

### 参照仕様セクション

- §8 全アセットの重み付け

---

## Phase 6: 監視・異常検知・ログ

### 目的

実運用に必要な監視・停止条件・ログ・再現性を担保し、
異常時の自動縮退と監査可能性を実現する。

### 成果物

| 成果物 | 説明 |
|--------|------|
| `anomaly_detector` | 異常検知モジュール |
| `fallback_handler` | 縮退モード制御 |
| `logger` | 構造化ログ出力 |
| `reproducibility_manager` | 再現性管理（seed、バージョン） |
| `pipeline_orchestrator` | 実行手順オーケストレーター |

### 依存関係

- **Phase 1-5**: 全フェーズの監視・ログが必要

### 技術的ポイント

1. **異常検知・縮退発動条件**（§9より）
   - 主要データソース障害、欠損率が閾値超
   - 直近のポートフォリオ想定損失が閾値超
   - 相関急上昇（多資産同時クラッシュ兆候）
   - バックテスト前提の崩壊疑い

2. **縮退モード**（§9より）
   - モード1: 前日重み維持
   - モード2: 均等配分へ退避
   - モード3: キャッシュ（w=0）

3. **必須ログ項目**（§10より）
   - 実行時刻、対象期間（train/test）
   - データ品質検査結果
   - 各Strategy×Assetの評価指標一式
   - Strategy採用/棄却理由
   - Asset配分の計算根拠
   - 例外・縮退モード発動の理由
   - 乱数seed、コード/設定のバージョン

4. **再現性要件**（§10より）
   - 同じ入力データ+同じ設定+同じseed → 同じ出力w
   - 設定は設定ファイルで固定管理

5. **実行手順**（§12より）
   1. データ取得 → 品質チェック → NG Assetをマーク
   2. 各Assetについて、各Strategyを生成（trainのみでパラメータ探索）
   3. testで評価指標算出（コスト控除、turnover計測）
   4. ゲートでStrategyを棄却
   5. Asset内でStrategy重みを算出
   6. Assetごとの期待値推定とリスク推定
   7. 全Assetの重みを最適化＋制約適用
   8. スムージング・変更量制限
   9. 異常判定 → 縮退モード適用（必要なら）
   10. 出力生成（weights + diagnostics）＆ログ保存

### 参照仕様セクション

- §9 "異常時"の停止・縮退
- §10 ログ・再現性・監査可能性
- §12 実行手順

---

## フェーズ間依存関係まとめ

| フェーズ | 依存先 | 提供するもの |
|----------|--------|--------------|
| Phase 1 | なし | データ、品質フラグ |
| Phase 2 | Phase 1 | Signal/Strategy定義 |
| Phase 3 | Phase 1, 2 | 評価指標、ゲート判定 |
| Phase 4 | Phase 3 | 戦略重み |
| Phase 5 | Phase 4 | Asset配分（最終重み） |
| Phase 6 | Phase 1-5 | 監視、ログ、縮退制御 |

---

## 運用パラメータ（事前決定必須）

以下は実装前に固定すべきパラメータ：

| カテゴリ | パラメータ | 推奨値例 |
|----------|------------|----------|
| リバランス | 頻度 | daily / weekly |
| 検証 | train_days | 730 |
| 検証 | test_days | 30 |
| 検証 | step_days | 30 |
| コスト | fee_bps | 2.0 |
| コスト | slippage_bps | 5.0 |
| ゲート | min_trades | 30 |
| ゲート | max_mdd | 0.25 |
| ゲート | min_ev | 0.0 |
| 戦略重み | beta | 2.0 |
| 戦略重み | w_strategy_max | 0.5 |
| 戦略重み | entropy_min | 0.8 |
| Asset配分 | method | HRP |
| Asset配分 | w_asset_max | 0.2 |
| Asset配分 | delta_max | 0.05 |
| Asset配分 | smooth_alpha | 0.3 |
| 縮退 | mode | hold_previous |
