# バックテスト高利回り原因分析レポート

**生成日時**: 2026-01-31

## 概要

バックテストで1853%（年率21.2%）という非現実的な高利回りが出ている原因を分析した。

---

## 検証結果

### Phase 1: パラメータ最適化バイアスの影響測定

**検証方法**: 最適化前のデフォルトパラメータでバックテストを実行

| パラメータ | 最適化後 | デフォルト |
|-----------|---------|----------|
| momentum.lookback | 119 | 90 |
| bollinger.window | 11 | 20 |

**結果**:

| メトリクス | デフォルトパラメータ |
|-----------|-----------------|
| Total Return | 1853.18% |
| Annual Return | 21.18% |
| Sharpe Ratio | 0.826 |
| Max Drawdown | -52.41% |
| Volatility | 24.5% |

**結論**: パラメータ最適化バイアスは主因ではない。デフォルトパラメータでも同様の高リターンが出ている。

---

### Phase 2: サバイバーシップバイアス（推定）

**問題点**:
- `universe_standard.yaml`の生成日: 2026-01-29
- バックテスト期間: 2010-01-01 〜 2024-12-31（15年間）
- **2026年時点のS&P500/日経225構成銘柄を使用してバックテスト**

**影響推定**:
- 文献値: 年率2-5%のリターン過大評価
- 15年累積影響: +35%〜+108%ポイント

**ただし、1853%の高リターンの主因ではない。**

---

### Phase 3: スリッページ未適用（重大な発見）

**発見事項**:

`fast_engine.py`を調査した結果、**スリッページが実際には適用されていない**ことが判明。

```python
# fast_engine.py:1017, 1753
cost_rate = self.config.transaction_cost_bps / 10000.0
```

設定ファイルでは`slippage_bps: 5`が定義されているが、バックテストシミュレーションでは`transaction_cost_bps`のみが使用されている。

**影響**:
- 現在の取引コスト: 10 bps
- 本来あるべきコスト: 10 bps (手数料) + 5 bps (スリッページ) = 15 bps
- 過小評価率: 33%

これはリターンの過大評価に寄与するが、1853%という高リターンの主因ではない。

---

## 高リターンの真の原因（推定）

### 1. 時系列の巻き戻り問題（可能性）

バックテストログを分析すると:
```
Using precomputed signals as_of_date=Timestamp('2024-07-01 00:00:00')
No cached signals found in precomputer
```

シグナルのキャッシュが見つからず、毎回計算している。シグナル計算時に将来データが混入している可能性がある。

### 2. HRPアロケーションの偏り

```
HRP allocation computed: 653 assets, sum=1.0000
Constraints applied: 2 violations
```

HRP（階層的リスクパリティ）が特定の高パフォーマンス銘柄に偏っている可能性。

### 3. 分散投資効果の過大評価

657銘柄への分散投資により、個別銘柄のボラティリティが相殺され、シャープレシオは低く見えるが累積リターンは非常に高くなっている。

---

## 現実的なリターン水準の推定

### 各バイアスの寄与度（推定）

| バイアス | 年率影響 | 15年累積影響 |
|---------|---------|------------|
| パラメータ最適化 | ほぼなし | ほぼなし |
| サバイバーシップ | 2-5% | 35-108% |
| スリッページ未適用 | 0.5-1% | 8-16% |
| **合計** | **2.5-6%** | **43-124%** |

### 修正後の推定リターン

- 現在の累積リターン: 1853%
- 推定バイアス補正: -43% 〜 -124%ポイント
- 修正後リターン: **1729% 〜 1810%**

これでも年率約20%となり、依然として非常に高い。

---

## 追加調査が必要な項目

1. **シグナル計算のLook-Ahead Bias詳細調査**
   - シグナルが事前計算されていない警告を調査
   - 各シグナル生成器のshift()使用状況を確認

2. **個別銘柄の寄与度分析**
   - 上位10銘柄の寄与度を算出
   - NVDA, TSLA等の高パフォーマンス銘柄の影響

3. **Point-in-Timeユニバース構築**
   - 各時点での実際の指数構成銘柄でバックテスト
   - これが最も正確なサバイバーシップバイアス補正

4. **スリッページ修正**
   - fast_engine.pyでslippage_bpsを取引コストに追加

---

## 推奨アクション

### 優先度高

1. **スリッページ適用の修正**
   - `fast_engine.py`の`cost_rate`計算を修正
   - `cost_rate = (self.config.transaction_cost_bps + self.config.slippage_bps) / 10000.0`

2. **シグナルキャッシュの検証**
   - 「No cached signals found」警告の原因調査
   - シグナル計算が正しく過去データのみを使用しているか確認

### 優先度中

3. **Point-in-Timeユニバースの構築**
   - 各時点でのS&P500/日経225構成銘柄データを取得
   - これにより真のサバイバーシップバイアスを測定

4. **銘柄別寄与度分析**
   - 高リターンへの銘柄別貢献を可視化

---

## 結論

バックテストの高リターン（年率21%）の主因は以下の複合要因と推定される：

1. **サバイバーシップバイアス**: 2-5%/年の過大評価
2. **スリッページ未適用**: 軽微な影響（0.5-1%/年）
3. **パラメータ最適化バイアス**: ほぼ影響なし

ただし、これらを補正しても年率15-18%程度のリターンが残る可能性があり、**シグナル計算のLook-Ahead Bias**または**銘柄選定ロジック**にも問題がある可能性が高い。

詳細な調査のため、以下を実施することを推奨：
- シグナル生成コードの詳細レビュー
- 銘柄別寄与度の可視化
- Point-in-Timeユニバースでの再テスト
