{% extends "base.html" %}

{% block title %}{{ run_id }} - バックテスト{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <a href="/" style="color: var(--primary-color); text-decoration: none;">&larr; ダッシュボードに戻る</a>
        <h2 style="margin-top: 0.5rem; color: var(--dark-color);">
            バックテスト
            <span id="status-badge" class="tag" style="margin-left: 0.5rem; background: var(--primary-color); color: white;">
                {{ status }}
            </span>
            {% if is_running %}
            <span class="live-indicator" style="margin-left: 0.5rem; color: var(--danger-color); font-size: 0.8rem;">
                &#9679; LIVE
            </span>
            {% endif %}
        </h2>
        <p style="color: #666; font-size: 0.9rem;">
            <code>{{ run_id }}</code>
        </p>
    </div>
    <div style="display: flex; gap: 0.5rem;">
        {% if is_running %}
        <button class="btn btn-danger" onclick="stopBacktest()">停止</button>
        {% endif %}
        <button class="btn btn-secondary" onclick="deleteProgress()">削除</button>
    </div>
</div>

<!-- エクイティカーブ -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            エクイティカーブ
            {% if is_running %}
            <span id="chart-live-badge" style="font-size: 0.75rem; color: var(--secondary-color); margin-left: 0.5rem;">
                リアルタイム更新中...
            </span>
            {% endif %}
        </h3>
        <div id="chart-stats" style="font-size: 0.85rem; color: #666;">
            <span id="stat-value">$--</span> |
            <span id="stat-return">--%</span>
        </div>
    </div>
    <div class="chart-container" style="height: 350px;">
        <canvas id="equityChart"></canvas>
    </div>
</div>

<!-- 2カラムレイアウト：進捗 + メトリクス -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
    <!-- 進捗情報（実行中のみ表示） -->
    <div class="card" id="progress-section" {% if not is_running %}style="display: none;"{% endif %}>
        <div class="card-header">
            <h3 class="card-title">実行進捗</h3>
        </div>
        <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
            <div class="stat-card" style="background: linear-gradient(135deg, var(--primary-color) 0%, #2980b9 100%);">
                <div class="stat-value" id="stat-phase">{{ progress.phase if progress else '--' }}</div>
                <div class="stat-label">フェーズ</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, var(--secondary-color) 0%, #27ae60 100%);">
                <div class="stat-value" id="stat-rebalance">
                    {% if progress %}
                    {{ progress.current_rebalance }}/{{ progress.total_rebalances }}
                    {% else %}
                    --/--
                    {% endif %}
                </div>
                <div class="stat-label">リバランス</div>
            </div>
        </div>
        <table style="margin-top: 1rem;">
            <tr>
                <td>推定完了</td>
                <td class="text-right" id="stat-eta">
                    {% if progress and progress.estimated_completion %}
                    {{ progress.estimated_completion[11:16] }}
                    {% else %}
                    --:--
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>現在の日付</td>
                <td class="text-right" id="stat-current-date">{{ progress.current_date if progress else '--' }}</td>
            </tr>
            <tr>
                <td>ユニバースサイズ</td>
                <td class="text-right">{{ progress.universe_size if progress else '--' }}</td>
            </tr>
        </table>
    </div>

    <!-- パフォーマンスメトリクス -->
    <div class="card" id="metrics-section">
        <div class="card-header">
            <h3 class="card-title">パフォーマンス（暫定）</h3>
        </div>
        <table>
            <tr>
                <td>累積リターン</td>
                <td class="text-right" id="metric-return">--</td>
            </tr>
            <tr>
                <td>現在価値</td>
                <td class="text-right" id="metric-value">--</td>
            </tr>
            <tr>
                <td>最大ドローダウン</td>
                <td class="text-right" id="metric-drawdown">--</td>
            </tr>
            <tr>
                <td>データポイント数</td>
                <td class="text-right" id="metric-datapoints">0</td>
            </tr>
        </table>
    </div>

    <!-- キャッシュ統計（完了済みは非表示） -->
    <div class="card" id="cache-section" {% if not is_running %}style="display: none;"{% endif %}>
        <div class="card-header">
            <h3 class="card-title">キャッシュ統計</h3>
        </div>
        <div id="cache-stats">
            {% if progress and progress.cache_stats %}
            <table>
                <thead>
                    <tr>
                        <th>キャッシュ</th>
                        <th class="text-right">ヒット率</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cache_name, stats in progress.cache_stats.items() %}
                    <tr>
                        <td>{{ cache_name }}</td>
                        <td class="text-right">
                            {% set total = stats.hits + stats.misses %}
                            {% if total > 0 %}
                            {{ "%.1f"|format(stats.hits / total * 100) }}%
                            {% else %}
                            --
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="padding: 1rem; text-align: center; color: #666;">
                統計収集中...
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 現在の保有銘柄（Top 5） -->
<div class="card" id="holdings-section">
    <div class="card-header">
        <h3 class="card-title">現在の保有銘柄（Top 5）</h3>
    </div>
    <div id="holdings-content">
        <table>
            <thead>
                <tr>
                    <th>銘柄</th>
                    <th class="text-right">ウェイト</th>
                </tr>
            </thead>
            <tbody id="holdings-tbody">
                <tr>
                    <td colspan="2" style="text-align: center; color: #666;">データ待機中...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- エラー・警告 -->
<div class="card" id="log-section" style="display: none;">
    <div class="card-header">
        <h3 class="card-title">ログ</h3>
    </div>
    <div id="log-container" style="max-height: 200px; overflow-y: auto;">
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        gap: 1rem;
    }
    .stat-card {
        color: white;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
    }
    .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
    }
    .stat-label {
        font-size: 0.8rem;
        opacity: 0.9;
    }
    .live-indicator {
        animation: blink 1s infinite;
    }
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }
    #chart-live-badge {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    const runId = "{{ run_id }}";
    const isRunning = {{ 'true' if is_running else 'false' }};
    const archiveId = "{{ archive_id or '' }}";

    // チャート関連
    let equityChart = null;
    let chartData = {
        labels: [],
        values: [],
        returns: []
    };

    // SSE接続
    let progressEventSource = null;
    let timeseriesEventSource = null;

    // 初期資本（仮定値、実際はprogressから取得）
    const initialCapital = {{ initial_capital or 1000000 }};

    function initChart() {
        const ctx = document.getElementById('equityChart').getContext('2d');
        equityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'ポートフォリオ価値',
                    data: chartData.values,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 300
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const returnPct = ((value / initialCapital) - 1) * 100;
                                return `$${value.toLocaleString()} (${returnPct >= 0 ? '+' : ''}${returnPct.toFixed(2)}%)`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        ticks: {
                            maxTicksLimit: 10,
                            font: { size: 10 }
                        }
                    },
                    y: {
                        display: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + (value / 1000).toFixed(0) + 'K';
                            },
                            font: { size: 10 }
                        }
                    }
                }
            }
        });
    }

    function updateChart(newPoints) {
        for (const point of newPoints) {
            chartData.labels.push(point.date);
            chartData.values.push(point.portfolio_value);
            chartData.returns.push(point.cumulative_return);
        }

        if (equityChart) {
            equityChart.data.labels = chartData.labels;
            equityChart.data.datasets[0].data = chartData.values;
            equityChart.update('none');
        }

        // メトリクス更新
        if (chartData.values.length > 0) {
            const latestValue = chartData.values[chartData.values.length - 1];
            const latestReturn = chartData.returns[chartData.returns.length - 1];

            document.getElementById('stat-value').textContent = '$' + latestValue.toLocaleString();
            document.getElementById('stat-return').textContent = (latestReturn >= 0 ? '+' : '') + (latestReturn * 100).toFixed(2) + '%';

            document.getElementById('metric-value').textContent = '$' + latestValue.toLocaleString();
            document.getElementById('metric-return').textContent = (latestReturn >= 0 ? '+' : '') + (latestReturn * 100).toFixed(2) + '%';
            document.getElementById('metric-datapoints').textContent = chartData.values.length;

            // 最大ドローダウン計算
            let maxValue = initialCapital;
            let maxDrawdown = 0;
            for (const val of chartData.values) {
                if (val > maxValue) maxValue = val;
                const dd = (maxValue - val) / maxValue;
                if (dd > maxDrawdown) maxDrawdown = dd;
            }
            document.getElementById('metric-drawdown').textContent = '-' + (maxDrawdown * 100).toFixed(2) + '%';
        }

        // 最新のウェイト表示
        if (newPoints.length > 0) {
            const latest = newPoints[newPoints.length - 1];
            updateHoldings(latest.weights_top5 || {});
        }
    }

    function updateHoldings(weights) {
        const tbody = document.getElementById('holdings-tbody');
        const entries = Object.entries(weights).sort((a, b) => b[1] - a[1]);

        if (entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #666;">データなし</td></tr>';
            return;
        }

        let html = '';
        for (const [symbol, weight] of entries) {
            html += `<tr>
                <td><strong>${symbol}</strong></td>
                <td class="text-right">${(weight * 100).toFixed(1)}%</td>
            </tr>`;
        }
        tbody.innerHTML = html;
    }

    function updateProgress(data) {
        document.getElementById('stat-phase').textContent = data.phase || '--';
        document.getElementById('stat-rebalance').textContent =
            `${data.current_rebalance || 0}/${data.total_rebalances || 0}`;
        document.getElementById('stat-eta').textContent =
            data.estimated_completion ? data.estimated_completion.slice(11, 16) : '--:--';
        document.getElementById('stat-current-date').textContent = data.current_date || '--';

        // ステータスバッジ更新
        const badge = document.getElementById('status-badge');
        if (data.status === 'completed') {
            badge.style.background = 'var(--secondary-color)';
            badge.textContent = '完了';
        } else if (data.status === 'failed') {
            badge.style.background = 'var(--danger-color)';
            badge.textContent = '失敗';
        }

        // キャッシュ統計更新
        if (data.cache_stats && Object.keys(data.cache_stats).length > 0) {
            let html = '<table><thead><tr><th>キャッシュ</th><th class="text-right">ヒット率</th></tr></thead><tbody>';
            for (const [name, stats] of Object.entries(data.cache_stats)) {
                const total = stats.hits + stats.misses;
                const rate = total > 0 ? (stats.hits / total * 100).toFixed(1) + '%' : '--';
                html += `<tr><td>${name}</td><td class="text-right">${rate}</td></tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('cache-stats').innerHTML = html;
        }

        // エラー・警告表示
        if ((data.errors && data.errors.length > 0) || (data.warnings && data.warnings.length > 0)) {
            document.getElementById('log-section').style.display = 'block';
            let logHtml = '';
            if (data.errors && data.errors.length > 0) {
                for (const error of data.errors) {
                    logHtml += `<div style="padding: 0.5rem; background: #f8d7da; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.85rem; color: #721c24;">${error}</div>`;
                }
            }
            if (data.warnings && data.warnings.length > 0) {
                for (const warning of data.warnings) {
                    logHtml += `<div style="padding: 0.5rem; background: #fff3cd; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.85rem; color: #856404;">${warning}</div>`;
                }
            }
            document.getElementById('log-container').innerHTML = logHtml;
        }
    }

    function setupProgressSSE() {
        progressEventSource = new EventSource(`/backtest/api/progress/${runId}/stream`);

        progressEventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.error) {
                console.error('Progress error:', data.error);
                progressEventSource.close();
                return;
            }

            if (data.status === 'done') {
                updateProgress(data.final);
                progressEventSource.close();
                // ライブ表示を終了
                document.querySelector('.live-indicator')?.remove();
                document.getElementById('chart-live-badge')?.remove();
                return;
            }

            updateProgress(data);
        };

        progressEventSource.onerror = function() {
            progressEventSource.close();
        };
    }

    function setupTimeseriesSSE() {
        timeseriesEventSource = new EventSource(`/backtest/api/progress/${runId}/timeseries/stream`);

        timeseriesEventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.error) {
                console.error('Timeseries error:', data.error);
                timeseriesEventSource.close();
                return;
            }

            if (data.timeseries && data.timeseries.length > 0) {
                updateChart(data.timeseries);
            }

            if (data.status === 'done') {
                timeseriesEventSource.close();
            }
        };

        timeseriesEventSource.onerror = function() {
            timeseriesEventSource.close();
        };
    }

    async function loadInitialTimeseries() {
        try {
            const response = await fetch(`/backtest/api/progress/${runId}/timeseries`);
            if (response.ok) {
                const data = await response.json();
                if (data.timeseries && data.timeseries.length > 0) {
                    updateChart(data.timeseries);
                }
            }
        } catch (err) {
            console.error('Failed to load initial timeseries:', err);
        }
    }

    async function stopBacktest() {
        if (!confirm('このバックテストを停止しますか？')) {
            return;
        }

        try {
            const jobsResponse = await fetch('/backtest/api/jobs?status=running');
            const jobs = await jobsResponse.json();
            const job = jobs.find(j => j.run_id === runId);

            if (job) {
                await fetch(`/backtest/api/job/${job.job_id}/stop`, { method: 'POST' });
                window.location.reload();
            }
        } catch (err) {
            console.error('Failed to stop backtest:', err);
            alert('停止に失敗しました');
        }
    }

    async function deleteProgress() {
        if (!confirm('この実行記録を削除しますか？')) {
            return;
        }

        try {
            const response = await fetch(`/backtest/api/progress/${runId}`, { method: 'DELETE' });
            if (response.ok) {
                window.location.href = '/';
            } else {
                alert('削除に失敗しました');
            }
        } catch (err) {
            console.error('Failed to delete progress:', err);
            alert('削除に失敗しました');
        }
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', async () => {
        initChart();

        // 初期データを読み込み
        await loadInitialTimeseries();

        // 実行中の場合はSSE接続を開始
        if (isRunning) {
            setupProgressSSE();
            setupTimeseriesSSE();
        }
    });

    // クリーンアップ
    window.addEventListener('beforeunload', () => {
        if (progressEventSource) progressEventSource.close();
        if (timeseriesEventSource) timeseriesEventSource.close();
    });
</script>
{% endblock %}
