# 自動検証＆動的アロケーション（実運用想定）

## 0. ミッション

1. 複数アセット（銘柄群）に対し、複数の候補シグナル（戦略/指標）を**同一ルールで検証**する
2. 過学習・データリークを抑えた評価で「使う/使わない」や「重み（配分）」を**動的に決める**
3. 実運用で必要な監視・停止条件・ログ・再現性（同じ入力→同じ出力）を担保する

出力は「**次のリバランス時点でのアセット別目標エクスポージャ（重み）**」と「それを裏付ける検証結果」。

---

## 1. 用語（本書内）

* **Asset**：取引対象（例：BTCUSD、AAPL、USDJPY 等）
* **Signal**：個別指標・アノマリー・ルール（BB逆張り、曜日効果など）
* **Strategy**：Signalを用いたポジション提案の生成器（-1〜+1、または0/1でも可）
* **Meta**：Strategy群の採用/重み付け、Asset配分を決める層
* **Rebalance**：一定周期で重みを更新する時点（例：毎日00:00 UTC）

---

## 2. スコープ / 非スコープ

### スコープ

* データ取得（価格/出来高/必要ならファンダや金利など）と前処理
* Signal/Strategyの定義と生成
* バックテスト（簡易でOK）による性能評価（実運用を想定した制約込み）
* Strategyの選別と重み付け（Meta）
* Asset配分（全アセットの重みを決定）
* 監視指標・異常検知・停止条件・ログ・再現性

### 非スコープ

* 注文執行（発注/キャンセル/約定管理）
* 取引所/証券API接続（ただし「出力フォーマット」は定義する）

---

## 3. 入力データ要件（実運用想定）

### 必須

* OHLCV（最低でも Close、できれば OHLCV）
* タイムゾーン・取引カレンダー（株なら休場、仮想通貨なら24/7）
* 手数料/スリッページの想定値（検証用のコストモデル）

### 推奨

* 信頼できるコーポレートアクション（株の分割・配当調整）
* 価格欠損・異常値（スパイク）のフラグ
* レートや金利など（FX/先物など必要な場合）

### データ品質チェック（毎回必須）

* 欠損率（バー欠落）・連続欠損
* 異常値（前バー比の極端な変化、出来高ゼロ等）
* 重複バー
* 時系列の単調増加（未来データ混入の疑い）

**品質NGなら「当該Assetは当日評価対象から除外」し、理由をログに残す。**

---

## 4. シグナル/戦略カタログの扱い（動的組み込み前提）

### Signal定義のルール

* すべてのSignalは、入力（過去データ）→出力（ポジション提案 or スコア）を返す純関数にする
* 出力は原則 **[-1, +1]**（ショート〜ロング）に正規化

  * 例：BB逆張りは逸脱量をtanhで圧縮して[-1,1]へ
* パラメータは「探索対象」と「固定」を分離

### 例：候補群（あくまで例）

* ボリンジャーバンド（逆張り/順張り）
* モメンタム（n日リターン）
* リバーサル（短期逆張り）
* ブレイクアウト（高値更新/レンジ）
* 出来高アノマリー（出来高スパイク）
* 曜日・月初月末など季節性（ただし過学習注意）

---

## 5. 検証方式（データリーク防止が最優先）

### ウォークフォワード（Walk-forward）

* 学習/最適化期間（train）と検証期間（test）を時間方向に分離
* 定期的にローリングして更新

  * 例：train 2年 → test 1ヶ月、毎月更新

### 交差検証（Time series CV）

* K分割でも **時系列順を保持**する（ランダムシャッフル禁止）
* 目的は「パラメータ過学習」検出

### パラメータ探索

* 探索範囲は事前固定（あとから都合よく変更しない）
* 探索結果は「その期間で最良」ではなく
  **安定性（分散が小さい、期間ごとの一貫性が高い）**を重視

---

## 6. 評価指標（勝率だけは禁止）

各Strategy×Assetの評価は最低でも以下を算出：

* 期待値（平均リターン、コスト控除後）
* ボラティリティ
* シャープ/ソルティノ（年率化ルールは明示）
* 最大ドローダウン（MDD）
* テールリスク（例：5% VaR/ES など簡易でも）
* 回転率（turnover）→ コスト影響の代理
* トレード数/有効サンプル数（少なすぎるものは棄却）

**棄却ルール例（ハードゲート）**

* test期間のトレード数 < 最低閾値
* MDD > 閾値
* コスト控除後の期待値 <= 0
* 過去N期のうちK期で期待値マイナス（安定性欠如）

---

## 7. Strategyの採用と重み（Meta：戦略アンサンブル）

### 7.1 目的

* 「直近で偶然勝っただけ」を避けつつ、環境変化に追随
* 単一Strategy依存を避ける（分散）

### 7.2 スコアリング（例）

Strategy (s), Asset (a) に対して、直近の評価期間で：

* 基本スコア：`score = Sharpe_adj - penalty`
* penalty例：

  * `λ1 * turnover`
  * `λ2 * MDD`
  * `λ3 * instability`（期間ごとの成績分散）

※ 係数λは固定値として管理（毎回変更しない）

### 7.3 戦略重み（Asset内）

Asset a の戦略集合 S_a から、softな重みを作る：

* まずゲートで不合格を除外
* 残りを `w_s ∝ exp(β * score_s)`（softmax）
* ただし上限・下限：

  * `w_s <= w_strategy_max`
  * 低スコアは0にクリップ（スパース化）

### 7.4 メタの過剰適応対策

* `β`（鋭さ）は固定 or 上限付きで調整
* “勝ち始めた戦略への全乗り”を避けるため
  **エントロピー下限**（多様性維持）を設ける

---

## 8. 全アセットの重み付け（ここが本題）

ここでは「各Assetの最終エクスポージャ（重み）」を決める。
取引はしないが、実運用想定なので制約を入れる。

### 8.1 入力

* 各Assetの「アンサンブル後の期待リターン推定」 μ_a
* 共分散推定 Σ（リターンの相関）
* リスク指標（ボラ、MDD近似、流動性 proxy）
* データ品質フラグ

### 8.2 目標

* 期待リターンを取りつつ、リスク（分散、相関集中）を抑える
* 不安定なAssetへ過度に寄らない
* 実装の安定性（毎日極端に変わらない）

### 8.3 推奨する配分アルゴリズム（現実的）

**A) リスクパリティ（RP）/ HRP（階層リスクパリティ）**

* 推定誤差に比較的強い
* 多アセット運用で堅い

**B) 平均分散（Markowitz）を使うなら強い正則化が必須**

* μ, Σの推定が不安定なので

  * μは縮小（0へ）
  * ΣはLedoit-Wolf等の縮小推定（簡易でも）

**C) バンディット的に「期待値推定に不確実性を織り込む」**

* 期待値の信頼区間が広いAssetは配分を抑える（安全側）

### 8.4 制約（必須）

* 総和：`Σ_a w_a = 1`（または許容キャッシュ）
* 上限：`w_a <= w_asset_max`
* 下限：`w_a >= 0`（ロングオンリー想定。ショート許可なら別途）
* 変更量制約：`|w_a(t) - w_a(t-1)| <= delta_max`（ターンオーバー抑制）
* 相関集中の抑制（任意だが推奨）

  * 同クラスタ（高相関群）の合計上限

### 8.5 データ品質/取引不能時の扱い

* 品質NGのAsset：`w_a = 0`（または前日維持）
  ルールは固定し、ログに理由

### 8.6 最終出力の安定化（必須）

* スムージング：`w_final = α*w_new + (1-α)*w_prev`
* もしくは「リバランス頻度を落とす」（週次など）

---

## 9. “異常時”の停止・縮退（実運用必須）

以下を満たしたら **Risk-Off**（配分を縮める/キャッシュ化/前日維持）を発動：

* 主要データソース障害、欠損率が閾値超
* 直近のポートフォリオ想定損失が閾値超（例：推定VaR悪化）
* 相関が急上昇し、分散効果が消えた（多資産同時クラッシュ兆候）
* バックテスト上の前提（コスト、流動性）が崩れた疑い

縮退モードの種類（固定で選ぶ）

* モード1：前日重み維持
* モード2：均等配分へ退避
* モード3：キャッシュ（w=0）※許容される場合

---

## 10. ログ・再現性・監査可能性

### 必須ログ

* 実行時刻、対象期間（train/test）
* データ品質検査結果（欠損率など）
* 各Strategy×Assetの評価指標一式
* Strategy採用/棄却理由
* Asset配分の計算根拠（μ, Σ, 制約、最終w）
* 例外・縮退モード発動の理由
* 乱数seed、コード/設定のバージョン

### 再現性要件

* 同じ入力データ+同じ設定+同じseed → 同じ出力w
* 設定（パラメータ探索範囲や閾値）は **設定ファイルで固定管理**

---

## 11. I/Oフォーマット（例）

### 設定（config）例

```json
{
  "rebalance": {"frequency": "daily", "time": "00:00:00Z"},
  "universe": ["ASSET1", "ASSET2", "ASSET3"],
  "cost_model": {"fee_bps": 2.0, "slippage_bps": 5.0},
  "validation": {"train_days": 730, "test_days": 30, "step_days": 30},
  "gates": {"min_trades": 30, "max_mdd": 0.25, "min_ev": 0.0},
  "strategy_weighting": {"beta": 2.0, "w_strategy_max": 0.5, "entropy_min": 0.8},
  "asset_weighting": {"method": "HRP", "w_asset_max": 0.2, "delta_max": 0.05, "smooth_alpha": 0.3},
  "fallback": {"mode": "hold_previous"}
}
```

### 出力（リバランス時）

```json
{
  "as_of": "2026-01-28T00:00:00Z",
  "weights": {
    "ASSET1": 0.12,
    "ASSET2": 0.20,
    "ASSET3": 0.00
  },
  "diagnostics": {
    "fallback_mode": null,
    "data_quality_excluded": ["ASSET3"],
    "portfolio_risk": {"vol": 0.11, "var_95": 0.025}
  }
}
```

---

## 12. 実行手順（エージェントの毎回の作業）

1. データ取得 → 品質チェック → NG Assetをマーク
2. 各Assetについて、各Strategyを生成（trainのみでパラメータ探索）
3. testで評価指標算出（コスト控除、turnover計測）
4. ゲートでStrategyを棄却
5. Asset内でStrategy重みを算出（softmax+上限+多様性）
6. Assetごとの期待値推定とリスク推定（Σ含む）
7. 全Assetの重みを最適化（HRP/RP推奨）＋制約適用
8. スムージング・変更量制限
9. 異常判定 → 縮退モード適用（必要なら）
10. 出力生成（weights + diagnostics）＆ログ保存

---

# 追加：最初に決め打ちしておくべき“運用パラメータ”

（ここをブレさせると運用が崩れます）

* リバランス頻度（毎日/毎週）
* train/test/step（どれくらいで更新するか）
* コストモデルの保守的な値
* ハードゲート閾値（min_trades, max_mdd, min_ev）
* Asset上限、変更量上限、スムージング係数
* 縮退モード（hold / equal / cash）
